name: Auto Query Generator

on:
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        description: "Select environment"
        options: [dev, staging, prod]
        required: true

      database_name:
        type: choice
        description: "Select the database"
        required: true
        options:
          - DeadLetter
          - DueDiligence
          - DueDiligencePreprod
          - DueDiligenceProd
          - ElasticJobsDev
          - ElasticJobsPreprod
          - ElasticJobsProd
          - InvestmentProperty
          - InvestmentPropertyPreprod
          - InvestmentPropertyProd
          - KnowledgeHub
          - KnowledgeHubPreprod
          - KnowledgeHubProd
          - Lead
          - LeadPreprod
          - LeadProd
          - ListingProperty
          - ListingPropertyPreprod
          - ListingPropertyProd
          - Notification
          - NotificationPreprod
          - NotificationProd
          - OcrOperation
          - OcrOperationPreprod
          - OcrOperationProd
          - ReferenceData
          - ReferenceDataPreprod
          - ReferenceDataProd
          - sqldb-booking-dev
          - sqldb-booking-prod
          - sqldb-booking-stage
          - sqldb-pone-dev
          - sqldb-pone-prod
          - sqldb-pone-stage
          - User
          - UserPreprod
          - UserProd
          - UserDataReport
          - instamortgagedev
          - instamortgagestg
          - instamortgageprod
          - tokenizationpropertydev
          - tokenizationpropertystg
          - tokenizationpropertyprod
          - tokenizatonduediligence
          - tokenizatonduediligencestg
          - tokenizatonduediligenceprod
          - kratosdev
          - kratosstg
          - kratosprod

      query_description:
        type: string
        description: "What does your query do?"
        required: true

      query:
        type: string
        description: "SQL query (supports multiline)"
        required: true

permissions:
  contents: write
  pull-requests: write

jobs:
  create-query-pr:
    runs-on: self-hosted-aks

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Detect server + validate DB
        id: detect
        run: |
          ENV="${{ inputs.environment }}"
          DB="${{ inputs.database_name }}"

          SQLSERVER_PATH="sqlserver/$ENV/$DB"
          POSTGRES_PATH="postgres/$ENV/$DB"

          if [[ -d "$SQLSERVER_PATH" ]]; then
            SERVER="sqlserver"
            FILE_PATH="$SQLSERVER_PATH/query_log.sql"
          elif [[ -d "$POSTGRES_PATH" ]]; then
            SERVER="postgres"
            FILE_PATH="$POSTGRES_PATH/query_log.sql"
          else
            echo "❌ Database '$DB' does not exist under '$ENV'"
            exit 1
          fi

          if [[ ! -f "$FILE_PATH" ]]; then
            echo "❌ query_log.sql missing at $FILE_PATH"
            exit 1
          fi

          echo "env=$ENV" >> $GITHUB_OUTPUT
          echo "server=$SERVER" >> $GITHUB_OUTPUT
          echo "file=$FILE_PATH" >> $GITHUB_OUTPUT

      - name: Create branch
        run: |
          BRANCH="auto-query-${{ inputs.database_name }}-$(date +%s)"
          git checkout -b "$BRANCH"
          echo "branch=$BRANCH" >> $GITHUB_ENV

      - name: Append query block
        run: |
          FILE="${{ steps.detect.outputs.file }}"
          EXECUTOR="${GITHUB_ACTOR}"
          DESC="${{ inputs.query_description }}"
          QID=$(date +"%Y-%m-%d_%H%M")

          # Write query block
          cat <<'EOF' >> "$FILE"

-- QUERY_ID: '"${QID}"'
-- EXECUTOR: '"${EXECUTOR}"'
-- DESCRIPTION: '"${DESC}"'

${{ inputs.query }};

-- END_QUERY
EOF

          git add "$FILE"

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          branch: ${{ env.branch }}
          commit_message: "Auto-add query for ${{ inputs.database_name }}"

      - name: Open Pull Request
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ env.branch }}
          base: main
          title: "Query PR for ${{ inputs.database_name }}"
          body: |
            Automated query PR.
            **DB:** ${{ inputs.database_name }}
            **Env:** ${{ inputs.environment }}
            **Description:** ${{ inputs.query_description }}
